<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nasoro AI</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { background:#050505; color:#fff; font-family:sans-serif; overflow:hidden; }
  textarea { background:transparent; border:none; resize:none; width:100%; color:#fff; }
  .chat-bubble { margin-bottom:1rem; }
  .chat-bubble.user { text-align:right; }
  .chat-bubble.nasoro { text-align:left; }
</style>
</head>
<body class="flex flex-col h-screen">

<div class="flex-1 overflow-y-auto p-4" id="chat-container">
  <div id="welcome-ui" class="text-center mt-24">
    <h1 class="text-4xl font-bold">Nasoro AI</h1>
    <p class="text-zinc-500">Intelligence refined.</p>
  </div>
</div>

<div class="p-4 bg-[#0f0f0f] flex flex-col gap-2">
  <!-- Version selection -->
  <select id="version-select" class="p-2 rounded text-black">
    <option value="1.2 Fast">Nasoro 1.2 Fast</option>
    <option value="1.2 Pro">Nasoro 1.2 Pro</option>
    <option value="2 Fast">Nasoro 2 Fast</option>
    <option value="2 Pro">Nasoro 2 Pro</option>
  </select>

  <!-- Image tray -->
  <div id="img-tray" class="flex gap-2 overflow-x-auto"></div>

  <div class="flex gap-2">
    <label class="w-12 h-12 flex items-center justify-center rounded bg-white text-black cursor-pointer">
      <i class="fa-solid fa-plus"></i>
      <input type="file" id="img-input" class="hidden" multiple accept="image/*">
    </label>
    <textarea id="chat-field" rows="1" placeholder="Talk with Nasoro..."></textarea>
    <button id="send-action" class="w-12 h-12 flex items-center justify-center bg-white text-black rounded">
      <i class="fa-solid fa-arrow-up"></i>
    </button>
  </div>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const chatField = document.getElementById('chat-field');
const sendAction = document.getElementById('send-action');
const imgInput = document.getElementById('img-input');
const imgTray = document.getElementById('img-tray');
const versionSelect = document.getElementById('version-select');

let attachments = [];
const sessionId = crypto.randomUUID();

// IMAGE UPLOAD SYSTEM
imgInput.addEventListener('change', e => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      attachments.push(ev.target.result);
      renderTray();
    };
    reader.readAsDataURL(file);
  });
});

function renderTray() {
  if(attachments.length) {
    imgTray.innerHTML = attachments.map((img, i) => `
      <div class="relative w-16 h-16">
        <img src="${img}" class="w-full h-full object-cover rounded">
        <div onclick="removeImg(${i})" class="absolute inset-0 bg-black/60 flex items-center justify-center cursor-pointer opacity-0 hover:opacity-100">
          <i class="fa-solid fa-trash text-white text-xs"></i>
        </div>
      </div>
    `).join('');
  } else imgTray.innerHTML = '';
}

window.removeImg = (i) => {
  attachments.splice(i,1);
  renderTray();
}

// CHAT CORE
chatField.addEventListener('input', () => {
  chatField.style.height = 'auto';
  chatField.style.height = chatField.scrollHeight + 'px';
});

function postMessage(content, role, imgs=[]) {
  document.getElementById('welcome-ui')?.classList.add('hidden');
  const html = `<div class="chat-bubble ${role}">
      <div><strong>${role==='nasoro'?'Nasoro':'You'}</strong></div>
      <div>${content.replace(/\n/g,'<br>')}</div>
      ${imgs.map(i=>`<img src="${i}" class="mt-2 rounded w-32 h-32 object-cover">`).join('')}
    </div>`;
  chatContainer.insertAdjacentHTML('beforeend', html);
  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior:'smooth' });
}

async function handleSend() {
  const msg = chatField.value.trim();
  if(!msg && attachments.length===0) return;

  const snapImg = [...attachments];
  postMessage(msg,'user', snapImg);

  chatField.value = '';
  chatField.style.height='auto';
  attachments = [];
  renderTray();
  sendAction.disabled = true;

  const version = versionSelect.value;

  try {
    const res = await fetch("/ai", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ message: msg, images: snapImg, version, sessionId })
    });
    const data = await res.json();
    postMessage(data.reply || "Thinking...", 'nasoro');
  } catch(err) {
    postMessage("Server error.",'nasoro');
    console.error(err);
  } finally {
    sendAction.disabled=false;
  }
}

sendAction.addEventListener('click', handleSend);
chatField.addEventListener('keydown', e => {
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
});
</script>

</body>
</html>
