<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nasoro AI</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/tokyo-night-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body { background-color:#050505; color:#fff; font-family:'Space Grotesk', sans-serif; overflow:hidden; height:100vh; width:100vw; }
#chat-container { flex:1; overflow-y:auto; padding:1rem; }
.msg-animate { animation: slideUp 0.3s ease-out forwards; }
@keyframes slideUp { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
textarea { resize:none; background:transparent; border:none; color:white; flex:1; }
#img-tray { display:flex; gap:0.5rem; margin-bottom:0.5rem; }
.img-thumb { width:64px; height:64px; border-radius:12px; position:relative; overflow:hidden; }
.img-thumb img { width:100%; height:100%; object-fit:cover; }
.img-thumb div { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); cursor:pointer; opacity:0; transition:opacity 0.2s; }
.img-thumb:hover div { opacity:1; }
</style>
</head>
<body class="flex flex-col">

<div id="chat-container" class="flex-1"></div>

<div class="p-4 flex flex-col">
  <div id="img-tray"></div>
  <div class="flex gap-2">
    <label class="bg-white text-black px-3 py-2 rounded-lg cursor-pointer">
      <i class="fa-solid fa-plus"></i>
      <input type="file" id="img-input" accept="image/*" multiple hidden>
    </label>
    <textarea id="chat-field" rows="1" placeholder="Talk with Nasoro..."></textarea>
    <button id="send-action" class="bg-white text-black px-4 rounded-lg"><i class="fa-solid fa-arrow-up"></i></button>
  </div>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const chatField = document.getElementById('chat-field');
const sendAction = document.getElementById('send-action');
const imgInput = document.getElementById('img-input');
const imgTray = document.getElementById('img-tray');

let attachments = [];

// Image upload
imgInput.addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      attachments.push(ev.target.result);
      renderTray();
    };
    reader.readAsDataURL(file);
  });
});

function renderTray() {
  imgTray.innerHTML = attachments.map((img, i) => `
    <div class="img-thumb">
      <img src="${img}">
      <div onclick="removeImg(${i})"><i class="fa-solid fa-trash text-white"></i></div>
    </div>
  `).join('');
}

window.removeImg = (i) => {
  attachments.splice(i,1);
  renderTray();
};

// Chat display
function postMessage(content, role, img) {
  const isNas = role === 'nasoro';
  let html = `<div class="msg-animate mb-4"><b>${isNas ? 'Nasoro' : 'You'}</b><br>`;
  if(img) html += `<img src="data:image/png;base64,${img}" class="rounded-xl mb-2" style="max-width:200px;">`;
  html += marked.parse(content || '') + '</div>';
  chatContainer.insertAdjacentHTML('beforeend', html);
  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior:'smooth' });
}

// Send message
async function handleSend() {
  const msg = chatField.value.trim();
  if(!msg && attachments.length === 0) return;

  // Show attachments in chat
  attachments.forEach(a => postMessage(null, 'user', a));
  postMessage(msg, 'user');

  const imgs = [...attachments];
  attachments = [];
  renderTray();
  chatField.value = '';
  sendAction.disabled = true;

  try {
    const isImagePrompt = msg.startsWith("/image ");
    const res = await fetch("https://nasoroai-production.up.railway.app/ai", {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ message: msg, images: imgs })
    });
    const data = await res.json();

    if(isImagePrompt && data.image) {
      postMessage("Here is your image:", 'nasoro', data.image);
    } else {
      postMessage(data.reply || "No response", 'nasoro');
    }

  } catch(err) {
    postMessage("Sync failed. Check backend connection.", 'nasoro');
    console.error(err);
  } finally {
    sendAction.disabled = false;
  }
}

// Send button only
sendAction.addEventListener('click', handleSend);

// Enter = newline
chatField.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatField.value += '\n'; }
});
</script>
</body>
</html>
