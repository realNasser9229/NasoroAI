<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nasoro AI</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/tokyo-night-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body { background: #050505; color: white; font-family: 'Space Grotesk', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
#chat-container { overflow-y: auto; flex: 1; padding: 1rem; }
.msg-animate { animation: slideUp 0.3s ease-out forwards; }
@keyframes slideUp { from { opacity:0; transform:translateY(10px) } to { opacity:1; transform:translateY(0) } }
textarea { resize: none; background: transparent; border: none; color:white; flex:1; padding:0.5rem; }
</style>
</head>
<body class="flex flex-col">

<div id="chat-container"></div>

<div class="p-3 flex items-end gap-2 bg-[#0f0f0f]">
  <label class="w-12 h-12 flex items-center justify-center rounded-2xl cursor-pointer hover:bg-white/10">
    <i class="fa-solid fa-plus text-zinc-500"></i>
    <input type="file" id="img-input" class="hidden" multiple accept="image/*">
  </label>
  <textarea id="chat-field" rows="1" placeholder="Talk with Nasoro..."></textarea>
  <button id="send-action" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-white text-black">
    <i class="fa-solid fa-arrow-up"></i>
  </button>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const chatField = document.getElementById('chat-field');
const sendAction = document.getElementById('send-action');
const imgInput = document.getElementById('img-input');

let attachments = [];

// IMAGE UPLOAD
imgInput.addEventListener('change', e => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => attachments.push(ev.target.result);
    reader.readAsDataURL(file);
  });
});

// POST MESSAGE
function postMessage(content, role, image=null) {
  const isNas = role==='nasoro';
  const username = role==='user' ? 'You' : 'Nasoro AI';
  let html = `
    <div class="flex gap-3 mb-4 msg-animate">
      <div class="w-10 h-10 rounded-2xl flex items-center justify-center border ${isNas?'bg-white text-black':'border-white/10 text-white'}">
        <span class="text-xs font-bold italic">${isNas?'N':'U'}</span>
      </div>
      <div>
        <p class="text-[10px] text-zinc-400 uppercase">${username}</p>
        <div>${marked.parse(content)}</div>
        ${image ? `<img src="data:image/png;base64,${image}" class="mt-2 w-48 h-48 object-cover rounded-lg">` : ''}
      </div>
    </div>
  `;
  chatContainer.insertAdjacentHTML('beforeend', html);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// HANDLE SEND
async function handleSend() {
  const msg = chatField.value.trim();
  if(!msg && attachments.length===0) return;

  postMessage(msg, 'user', null);
  chatField.value = '';
  chatField.style.height='auto';
  const snapAttachments = [...attachments];
  attachments = [];

  postMessage("Typing...", 'nasoro');

  try {
    const res = await fetch("https://nasoroai-production.up.railway.app/ai", {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg, images: snapAttachments })
    });
    const data = await res.json();

    // remove typing
    chatContainer.querySelectorAll('.msg-animate').forEach(el => {
      if(el.innerText.includes("Typing...")) el.remove();
    });

    if(data.image) postMessage("", 'nasoro', data.image);
    if(data.reply) postMessage(data.reply, 'nasoro');

  } catch {
    postMessage("Sync failed. Check backend connection.", 'nasoro');
  }
}

sendAction.addEventListener('click', handleSend);
chatField.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.stopPropagation(); } // Enter only newline
});
</script>

</body>
</html>
