<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Nasoro AI</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gh: {
              bg: '#0d1117',
              sidebar: '#161b22',
              border: '#30363d',
              input: '#0d1117',
              primary: '#238636',
              primaryHover: '#2ea043',
              text: '#c9d1d9',
              muted: '#8b949e'
            }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0d1117; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #8b949e; }

    /* Typing Animation */
    .dot-flashing {
      position: relative;
      width: 6px; height: 6px;
      border-radius: 5px;
      background-color: #8b949e;
      color: #8b949e;
      animation: dot-flashing 1s infinite linear alternate;
      animation-delay: 0.5s;
    }
    .dot-flashing::before, .dot-flashing::after {
      content: ""; display: inline-block; position: absolute; top: 0;
      width: 6px; height: 6px; border-radius: 5px; background-color: #8b949e; color: #8b949e;
      animation: dot-flashing 1s infinite alternate;
    }
    .dot-flashing::before { left: -10px; animation-delay: 0s; }
    .dot-flashing::after { left: 10px; animation-delay: 1s; }
    @keyframes dot-flashing { 0% { background-color: #8b949e; } 50%, 100% { background-color: #2b3137; } }

    /* Code Block Copy Button Styles */
    .code-wrapper { position: relative; margin-top: 10px; }
    .copy-btn {
      position: absolute; top: 5px; right: 5px;
      background: #30363d; color: #c9d1d9;
      border: 1px solid #6e7681; border-radius: 6px;
      padding: 4px 8px; font-size: 12px; cursor: pointer;
      opacity: 0; transition: opacity 0.2s;
    }
    .code-wrapper:hover .copy-btn { opacity: 1; }
  </style>
</head>
<body class="bg-gh-bg text-gh-text h-screen flex overflow-hidden">

  <aside class="hidden md:flex flex-col w-64 bg-gh-sidebar border-r border-gh-border p-4">
    <div class="flex items-center gap-3 mb-6">
      <i class="fa-brands fa-github text-3xl text-white"></i>
      <h1 class="font-bold text-xl tracking-tight text-white">NasoroAI</h1>
    </div>
    
    <div class="flex-1 overflow-y-auto">
      <div class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-2">Capabilities</div>
      <ul class="space-y-2 text-sm">
        <li class="p-2 rounded bg-gh-border/50 text-white cursor-pointer"><i class="fa-solid fa-code mr-2"></i> Code Review</li>
        <li class="p-2 rounded hover:bg-gh-border/30 text-gh-muted cursor-pointer transition"><i class="fa-solid fa-bug mr-2"></i> Debugging</li>
        <li class="p-2 rounded hover:bg-gh-border/30 text-gh-muted cursor-pointer transition"><i class="fa-solid fa-book mr-2"></i> Documentation</li>
      </ul>
    </div>

    <div class="mt-auto pt-4 border-t border-gh-border">
      <div class="flex items-center gap-2 text-sm text-gh-muted">
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
        System Operational
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full relative">
    
    <header class="md:hidden flex items-center justify-between p-4 bg-gh-sidebar border-b border-gh-border">
      <div class="flex items-center gap-2">
        <i class="fa-brands fa-github text-xl"></i>
        <span class="font-bold">NasoroAI</span>
      </div>
      <button class="text-gh-muted"><i class="fa-solid fa-bars"></i></button>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
      <div class="flex gap-4 max-w-3xl mx-auto">
        <div class="w-8 h-8 rounded-full bg-black border border-gh-border flex items-center justify-center flex-shrink-0">
          <i class="fa-brands fa-github text-white text-sm"></i>
        </div>
        <div class="flex-1 space-y-2">
          <div class="flex items-center gap-2">
            <span class="font-bold text-sm text-white">NasoroAI</span>
            <span class="text-xs text-gh-muted">Just now</span>
          </div>
          <div class="text-gh-text leading-relaxed">
            Hello! I am your GitHub AI Assistant. I can help you analyze repositories, write code, or explain complex pull requests. How can I help you today?
          </div>
        </div>
      </div>
    </div>

    <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-gh-bg via-gh-bg to-transparent pb-6 pt-10 px-4">
      <div class="max-w-3xl mx-auto relative bg-gh-sidebar border border-gh-border rounded-xl shadow-2xl">
        <textarea 
          id="user-input" 
          rows="1"
          placeholder="Ask NasoroAI anything..." 
          class="w-full bg-transparent text-white p-4 pr-12 rounded-xl focus:outline-none resize-none overflow-hidden max-h-48"
          style="min-height: 56px;"
        ></textarea>
        
        <button id="send-btn" class="absolute right-3 bottom-3 p-2 bg-gh-primary hover:bg-gh-primaryHover text-white rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fa-solid fa-paper-plane text-sm"></i>
        </button>
      </div>
      <div class="text-center mt-2">
        <p class="text-xs text-gh-muted">NasoroAI can make mistakes. Consider checking important information.</p>
      </div>
    </div>

  </main>

  <script>
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const BACKEND_URL = "https://nasoroai-production.up.railway.app/ai";

    // Configure Marked to use Highlight.js
    marked.setOptions({
      highlight: function(code, lang) {
        const language = highlight.getLanguage(lang) ? lang : 'plaintext';
        return highlight.highlight(code, { language }).value;
      },
      langPrefix: 'hljs language-'
    });

    // Auto-resize textarea
    userInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      if(this.value === '') this.style.height = '56px';
    });

    function createMessageHTML(content, role) {
      const isAi = role === 'ai';
      const avatarIcon = isAi ? 'fa-github' : 'fa-user';
      const name = isAi ? 'NasoroAI' : 'You';
      const bgColor = isAi ? 'bg-black' : 'bg-blue-600';
      
      // Parse Markdown if AI
      let messageBody = isAi ? marked.parse(content) : content.replace(/\n/g, '<br>');

      return `
        <div class="flex gap-4 max-w-3xl mx-auto fade-in">
          <div class="w-8 h-8 rounded-full ${bgColor} border border-gh-border flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fa-brands ${avatarIcon} text-white text-sm"></i>
          </div>
          <div class="flex-1 space-y-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="font-bold text-sm text-white">${name}</span>
            </div>
            <div class="text-gh-text leading-relaxed prose prose-invert max-w-none break-words">
              ${messageBody}
            </div>
          </div>
        </div>
      `;
    }

    function addLoader() {
      const id = 'loader-' + Date.now();
      const html = `
        <div id="${id}" class="flex gap-4 max-w-3xl mx-auto">
          <div class="w-8 h-8 rounded-full bg-black border border-gh-border flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fa-brands fa-github text-white text-sm"></i>
          </div>
          <div class="flex-1 py-3">
             <div class="dot-flashing"></div>
          </div>
        </div>
      `;
      chatContainer.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
      return id;
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Add Copy Button to Code Blocks
    function attachCopyButtons() {
      document.querySelectorAll('pre code').forEach((block) => {
        if (block.parentNode.classList.contains('code-wrapper')) return; // Already attached

        const pre = block.parentNode;
        const wrapper = document.createElement('div');
        wrapper.className = 'code-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.innerHTML = '<i class="fa-regular fa-copy"></i> Copy';
        
        button.addEventListener('click', () => {
          navigator.clipboard.writeText(block.innerText).then(() => {
            button.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
            setTimeout(() => button.innerHTML = '<i class="fa-regular fa-copy"></i> Copy', 2000);
          });
        });

        wrapper.appendChild(button);
      });
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      // 1. Add User Message
      chatContainer.insertAdjacentHTML('beforeend', createMessageHTML(text, 'user'));
      userInput.value = '';
      userInput.style.height = '56px'; // Reset height
      sendBtn.disabled = true;
      scrollToBottom();

      // 2. Add Loader
      const loaderId = addLoader();

      try {
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, provider: "openai" })
        });

        const data = await response.json();
        
        // 3. Remove Loader & Add AI Response
        document.getElementById(loaderId).remove();
        chatContainer.insertAdjacentHTML('beforeend', createMessageHTML(data.reply || "No response received.", 'ai'));
        
        // 4. Highlight Code & Attach Copy Buttons
        attachCopyButtons();
        
      } catch (err) {
        document.getElementById(loaderId).remove();
        chatContainer.insertAdjacentHTML('beforeend', createMessageHTML("Error: Could not reach backend.", 'ai'));
      } finally {
        sendBtn.disabled = false;
        scrollToBottom();
        userInput.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
  </html>
  
