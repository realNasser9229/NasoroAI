<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nasoro AI by OpenOro™</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/tokyo-night-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          colors: { 
            nasoro: { bg: '#020202', card: '#0a0a0a' } 
          },
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          animation: {
            'spin-slow': 'spin 3s linear infinite',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        } 
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background-color: #020202; color: #f4f4f5; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
    
    .bg-mesh {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: 
        radial-gradient(circle at 15% 15%, rgba(59, 130, 246, 0.05) 0%, transparent 45%),
        radial-gradient(circle at 85% 85%, rgba(139, 92, 246, 0.05) 0%, transparent 45%);
    }

    /* --- STARTUP ANIMATION --- */
    #startup-screen {
      position: fixed; inset: 0; z-index: 100;
      background: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.8s ease-out, visibility 0.8s;
    }
    .loader-logo {
      width: 60px; height: 60px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 16px;
      animation: breathe 2s ease-in-out infinite alternate;
      box-shadow: 0 0 30px rgba(59,130,246,0.3);
    }
    @keyframes breathe { 0% { transform: scale(0.95); opacity: 0.8; } 100% { transform: scale(1.05); opacity: 1; } }

    /* --- GATEWAY (CAPTCHA) --- */
    #security-gateway {
      position: fixed; inset: 0; z-index: 90;
      background: rgba(2, 2, 2, 0.95);
      backdrop-filter: blur(20px);
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.5s ease-in-out;
    }

    .glass-sidebar { background: rgba(5, 5, 5, 0.95); border-right: 1px solid rgba(255,255,255,0.06); }
    .glass-header { background: rgba(2, 2, 2, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.06); }

    @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .msg-anim { animation: slideUp 0.4s cubic-bezier(0.2, 0.9, 0.3, 1) forwards; }
    .sidebar-active { transform: translateX(0) !important; }
    
    .model-btn { transition: all 0.2s ease; border: 1px solid transparent; }
    .model-btn:hover { background: rgba(255,255,255,0.05); }
    .model-btn.active { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .model-btn.active .icon-box { transform: scale(1.1); }

    .input-wrapper {
      background: #0f0f0f; border: 1px solid rgba(255,255,255,0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-wrapper:focus-within { border-color: rgba(255,255,255,0.25); box-shadow: 0 0 20px rgba(59, 130, 246, 0.1); }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    
    .prose pre { background: #0d0d0d !important; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-top: 1rem; position: relative; }
    .prose code { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; }
    .prose strong { color: white; font-weight: 700; }
    
    .copy-btn {
      position: absolute; top: 8px; right: 8px;
      background: rgba(255,255,255,0.1); color: #aaa;
      border-radius: 4px; padding: 4px 8px; font-size: 10px;
      cursor: pointer; border: none;
    }
    .typing-dot { width: 6px; height: 6px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

    .img-preview-wrap { position: relative; display: inline-block; margin-right: 8px; }
    .img-preview-wrap img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); }
    .img-remove { 
      position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
    }
  </style>
</head>
<body class="flex flex-col md:flex-row h-screen text-sm md:text-base">
  
  <div class="bg-mesh"></div>

  <div id="startup-screen">
    <div class="loader-logo mb-6"></div>
    <h1 class="text-2xl font-bold text-white tracking-widest uppercase">Nasoro AI</h1>
    <p class="text-zinc-500 text-xs mt-2 font-mono">Initializing Neural Nets...</p>
  </div>

  <div id="security-gateway">
    <div class="bg-[#0f0f0f] p-8 rounded-2xl border border-white/10 text-center max-w-sm w-full shadow-2xl">
      <div class="w-12 h-12 bg-zinc-800 rounded-full mx-auto flex items-center justify-center mb-4">
        <i class="fa-solid fa-shield-halved text-zinc-400"></i>
      </div>
      <h2 class="text-xl font-bold text-white mb-2">Security Check</h2>
      <p class="text-zinc-500 text-xs mb-6">Please verify you are human to access Nasoro.</p>
      
      <button onclick="onTurnstileSuccess()" class="w-full py-3 bg-white text-black font-bold rounded-lg hover:bg-zinc-200 transition-colors flex items-center justify-center gap-2">
        <i class="fa-regular fa-square-check"></i> I am human
      </button>
    </div>
  </div>

  <aside id="sidebar" class="fixed inset-y-0 left-0 w-[280px] -translate-x-full md:relative md:translate-x-0 glass-sidebar z-[50] flex flex-col transition-transform duration-300 ease-in-out">
    <div class="p-6 pb-2">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center shadow-lg shadow-blue-900/20">
          <i class="fa-solid fa-cube text-white text-lg"></i>
        </div>
        <div>
          <h1 class="font-bold text-lg tracking-tight text-white">Nasoro</h1>
          <p class="text-[10px] text-zinc-500 font-mono uppercase tracking-widest">Neural v2.5</p>
        </div>
      </div>
      
      <button onclick="startNewChat()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-white/5 hover:bg-white/10 text-zinc-200 transition-all border border-white/5 hover:border-white/10 group mb-2">
        <div class="w-6 h-6 rounded-md bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors"><i class="fa-solid fa-plus text-xs"></i></div>
        <span class="font-medium text-sm">New Session</span>
      </button>

      <button onclick="toggleNotifications()" id="notify-btn" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/5 text-zinc-500 hover:text-zinc-300 transition-all">
        <i class="fa-solid fa-bell text-xs"></i> <span class="text-xs">Enable Hot-Takes</span>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto px-4 py-2 space-y-6">
      <div class="bg-zinc-900/50 p-3 rounded-lg border border-white/5">
        <label class="text-[10px] uppercase text-zinc-500 font-bold mb-2 block">Your Persona</label>
        <input type="text" id="custom-persona" placeholder="e.g. 'Talk like a pirate'" class="w-full bg-black/50 border border-white/10 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-blue-500">
      </div>

      <div>
        <h3 class="text-[10px] uppercase tracking-widest text-zinc-600 font-bold mb-3 px-2">Core Models</h3>
        <div class="space-y-1">
          <button onclick="setModel('nasoro-2-fast')" id="btn-fast" class="model-btn w-full flex items-center gap-3 p-2 rounded-lg text-left active">
            <div class="icon-box w-8 h-8 rounded-md bg-cyan-500/10 text-cyan-400 flex items-center justify-center"><i class="fa-solid fa-bolt text-xs"></i></div>
            <div><p class="font-semibold text-zinc-200 text-xs">Oro 2 Fast</p><p class="text-[10px] text-zinc-500">Speed optimized.</p></div>
          </button>
          <button onclick="setModel('nasoro-2')" id="btn-std" class="model-btn w-full flex items-center gap-3 p-2 rounded-lg text-left">
            <div class="icon-box w-8 h-8 rounded-md bg-white/10 text-zinc-200 flex items-center justify-center"><i class="fa-solid fa-microchip text-xs"></i></div>
            <div><p class="font-semibold text-zinc-200 text-xs">Oro 2</p><p class="text-[10px] text-zinc-500">Balanced logic.</p></div>
          </button>
          <button onclick="setModel('nasoro-2-pro')" id="btn-pro" class="model-btn w-full flex items-center gap-3 p-2 rounded-lg text-left">
            <div class="icon-box w-8 h-8 rounded-md bg-violet-500/10 text-violet-400 flex items-center justify-center"><i class="fa-solid fa-brain text-xs"></i></div>
            <div><p class="font-semibold text-zinc-200 text-xs">Oro 2 Pro</p><p class="text-[10px] text-zinc-500">Deep logic.</p></div>
          </button>
        </div>
      </div>

      <div>
        <h3 class="text-[10px] uppercase tracking-widest text-zinc-600 font-bold mb-3 px-2">Specialists</h3>
        <div class="space-y-1">
          <button onclick="setModel('nasoro-2-coder')" id="btn-coder" class="model-btn w-full flex items-center gap-3 p-2 rounded-lg text-left">
            <div class="icon-box w-8 h-8 rounded-md bg-emerald-500/10 text-emerald-400 flex items-center justify-center"><i class="fa-solid fa-code text-xs"></i></div>
            <div><p class="font-semibold text-zinc-200 text-xs">Oro 2 Coder</p><p class="text-[10px] text-zinc-500">Optimized scripting.</p></div>
          </button>
          <button onclick="setModel('nasoro-2-scientist')" id="btn-scientist" class="model-btn w-full flex items-center gap-3 p-2 rounded-lg text-left">
            <div class="icon-box w-8 h-8 rounded-md bg-teal-500/10 text-teal-400 flex items-center justify-center"><i class="fa-solid fa-flask text-xs"></i></div>
            <div><p class="font-semibold text-zinc-200 text-xs">Oro 2 Scientist</p><p class="text-[10px] text-zinc-500">Researcher / Search.</p></div>
          </button>
          <button onclick="setModel('nasoro-2-image')" id="btn-image" class="model-btn w-full flex items-center gap-3 p-2 rounded-lg text-left">
            <div class="icon-box w-8 h-8 rounded-md bg-pink-500/10 text-pink-400 flex items-center justify-center"><i class="fa-solid fa-paint-brush text-xs"></i></div>
            <div><p class="font-semibold text-zinc-200 text-xs">Oro 2 Image</p><p class="text-[10px] text-zinc-500">Flux Art Engine.</p></div>
          </button>
        </div>
      </div>
      
      <div>
        <h3 class="text-[10px] uppercase tracking-widest text-zinc-600 font-bold mb-3 px-2">Memory Archive</h3>
        <div id="history-list" class="space-y-1"></div>
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col relative h-full overflow-hidden z-10 bg-[#020202]">
    <header class="md:hidden h-14 flex items-center justify-between px-4 glass-header shrink-0 z-40">
      <button onclick="openSidebar()" class="text-zinc-400 hover:text-white"><i class="fa-solid fa-bars"></i></button>
      <span class="font-bold text-sm tracking-widest uppercase">Nasoro 2.5</span>
      <div class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto px-4 md:px-0 pt-6 pb-32 scroll-smooth">
      <div id="welcome-ui" class="h-full flex flex-col items-center justify-center text-center px-6 -mt-10">
        <div class="relative mb-6 group cursor-default">
          <div class="absolute inset-0 bg-blue-500/20 blur-3xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-1000"></div>
          <img src="https://i.postimg.cc/SRc9H0j8/Screenshot-2026-01-06-18-13-41-32-74158c69f0af68fbf38b28b8774cd491.jpg" class="relative w-24 h-24 md:w-32 md:h-32 rounded-[2rem] shadow-2xl border border-white/10 object-cover">
        </div>
        <h1 class="text-3xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-zinc-500 mb-4 tracking-tight">How can I help?</h1>
        <p class="text-zinc-500 text-sm md:text-base max-w-md">Intelligence refined. Now with Researcher & Custom Persona.</p>
      </div>
    </div>

    <div class="absolute bottom-0 left-0 w-full p-4 md:p-6 bg-gradient-to-t from-[#020202] via-[#020202] to-transparent z-30">
      <div class="max-w-3xl mx-auto">
        <div id="image-preview-container" class="flex flex-wrap gap-2 mb-2 px-1"></div>
        <div id="input-container" class="input-wrapper rounded-3xl p-2 flex items-end gap-2 relative">
          <label class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full hover:bg-white/10 cursor-pointer text-zinc-400 hover:text-white transition-colors flex-shrink-0 mb-1">
            <i class="fa-solid fa-paperclip text-lg"></i>
            <input type="file" id="img-input" class="hidden" accept="image/*" multiple>
          </label>
          <textarea id="chat-field" rows="1" placeholder="Send a message..." class="flex-1 bg-transparent border-none focus:ring-0 py-3 md:py-4 text-white placeholder-zinc-600 text-[15px] md:text-base resize-none max-h-48 overflow-y-auto" style="min-height: 24px;"></textarea>
          <button id="send-action" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full bg-white text-black hover:bg-zinc-200 transition-colors flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed mb-1">
            <i class="fa-solid fa-arrow-up text-lg"></i>
          </button>
        </div>
        <p class="text-center text-[10px] text-zinc-700 mt-3 font-mono">Nasoro checks inputs for efficiency. Specialists have limit 15.</p>
      </div>
    </div>
  </main>

  <div id="overlay" onclick="closeSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden backdrop-blur-sm transition-opacity"></div>
  <div id="rate-limit-badge" class="fixed bottom-5 right-5 bg-red-500/10 border border-red-500/50 text-red-200 px-4 py-2 rounded-lg text-xs font-bold hidden backdrop-blur-md"></div>

  <script>
    const API_URL = "https://nasoroai-production.up.railway.app/ai"; 
    const LOGO_URL = "https://i.postimg.cc/SRc9H0j8/Screenshot-2026-01-06-18-13-41-32-74158c69f0af68fbf38b28b8774cd491.jpg";

    const chatContainer = document.getElementById('chat-container');
    const welcomeUi = document.getElementById('welcome-ui');
    const chatField = document.getElementById('chat-field');
    const sendAction = document.getElementById('send-action');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const imgInput = document.getElementById('img-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const customPersonaInput = document.getElementById('custom-persona');
    
    let currentChatId = Date.now();
    let currentModel = 'nasoro-2-fast';
    let allChats = JSON.parse(localStorage.getItem('nasoro_ultra_archive') || '{}');
    let selectedImages = [];
    
    // --- STARTUP LOGIC ---
    window.addEventListener('load', () => {
      // 1. Fade out startup screen
      setTimeout(() => {
        const startup = document.getElementById('startup-screen');
        startup.style.opacity = '0';
        startup.style.visibility = 'hidden';
      }, 2000); // 2 seconds animation
    });

    // --- CAPTCHA LOGIC ---
    function onTurnstileSuccess() {
      // Called when Turnstile verifies or Simulated button clicked
      const gateway = document.getElementById('security-gateway');
      gateway.style.transform = "translateY(-100%)"; // Slide up away
    }

    // --- NOTIFICATIONS LOGIC ---
    const hotTakes = [
      "Nasoro on the way to save you from psychological boredom! Wahoo!",
      "Pro tip: The Scientist model thinks harder than I do.",
      "Just checked the servers, they're chilly.",
      "Are you coding? Oro Coder is waiting.",
      "Did you know? I don't sleep. Ever."
    ];

    function toggleNotifications() {
      if (!("Notification" in window)) {
        alert("This browser does not support desktop notifications");
        return;
      }
      
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          document.getElementById('notify-btn').innerHTML = '<i class="fa-solid fa-check text-green-500"></i> Enabled';
          new Notification("Notifications Enabled", { body: "Nasoro will now drop hot takes randomly." });
          
          // Start Hot Take Interval (Every 10-30 mins for demo purposes)
          setInterval(() => {
            if(document.visibilityState === 'visible') { // Only if tab open/visible
               const randomTake = hotTakes[Math.floor(Math.random() * hotTakes.length)];
               new Notification("Nasoro says:", { body: randomTake, icon: LOGO_URL });
            }
          }, 600000); // 10 minutes
        }
      });
    }

    // --- EXISTING CHAT LOGIC ---
    chatField.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      if(this.value === '') this.style.height = 'auto';
    });

    function openSidebar() { sidebar.classList.add('sidebar-active'); overlay.classList.remove('hidden'); }
    function closeSidebar() { sidebar.classList.remove('sidebar-active'); overlay.classList.add('hidden'); }

    function setModel(key) {
      currentModel = key;
      document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
      const btnMap = { 'nasoro-2-fast':'btn-fast', 'nasoro-2':'btn-std', 'nasoro-2-pro':'btn-pro', 'nasoro-2-chat':'btn-chat', 'nasoro-2-coder':'btn-coder', 'nasoro-2-scientist':'btn-scientist', 'nasoro-2-image':'btn-image' };
      const btnId = btnMap[key];
      if(btnId) document.getElementById(btnId).classList.add('active');
      if(window.innerWidth < 768) closeSidebar();
    }

    imgInput.addEventListener('change', (e) => {
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const base64 = event.target.result;
          if(!selectedImages.includes(base64)) {
            selectedImages.push(base64);
            renderImages();
          }
        };
        reader.readAsDataURL(file);
      });
      imgInput.value = '';
    });

    function renderImages() {
      imagePreviewContainer.innerHTML = selectedImages.map((src, index) => `
        <div class="img-preview-wrap">
          <img src="${src}">
          <div class="img-remove" onclick="removeImage(${index})"><i class="fa-solid fa-times"></i></div>
        </div>
      `).join('');
    }

    window.removeImage = (index) => { selectedImages.splice(index, 1); renderImages(); };

    function saveContext() {
      const msgs = Array.from(chatContainer.querySelectorAll('.msg-group')).map(el => el.outerHTML);
      if(msgs.length > 0) {
        const rawText = chatContainer.querySelector('.user-txt')?.innerText || "New Conversation";
        allChats[currentChatId] = { title: rawText.substring(0, 30), html: msgs };
        localStorage.setItem('nasoro_ultra_archive', JSON.stringify(allChats));
        renderArchive();
      }
    }

    function renderArchive() {
      const historyList = document.getElementById('history-list');
      const ids = Object.keys(allChats).sort((a,b) => b-a);
      historyList.innerHTML = ids.length ? ids.map(id => `
        <div class="group flex items-center justify-between p-2 hover:bg-white/5 rounded-lg cursor-pointer transition-colors" onclick="loadChat('${id}')">
          <div class="flex items-center gap-3 min-w-0">
             <i class="fa-regular fa-message text-zinc-600 text-xs"></i>
             <span class="text-xs text-zinc-300 truncate">${allChats[id].title}</span>
          </div>
          <button onclick="deleteChat('${id}', event)" class="text-zinc-600 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash text-xs"></i></button>
        </div>
      `).join('') : '<p class="text-[10px] text-zinc-600 p-2 italic">No history found.</p>';
    }

    window.deleteChat = (id, e) => { e.stopPropagation(); delete allChats[id]; localStorage.setItem('nasoro_ultra_archive', JSON.stringify(allChats)); renderArchive(); if(currentChatId == id) startNewChat(); };
    window.loadChat = (id) => { currentChatId = id; welcomeUi.classList.add('hidden'); chatContainer.innerHTML = allChats[id].html.join(''); addCopyListeners(); chatContainer.scrollTop = chatContainer.scrollHeight; if(window.innerWidth < 768) closeSidebar(); };
    window.startNewChat = () => { currentChatId = Date.now(); chatContainer.innerHTML = ''; chatContainer.appendChild(welcomeUi); welcomeUi.classList.remove('hidden'); selectedImages = []; renderImages(); if(window.innerWidth < 768) closeSidebar(); };

    function postMessage(content, role, images = []) {
      welcomeUi.classList.add('hidden');
      const isNas = role === 'nasoro';
      let imgHtml = images.map(src => `<img src="${src}" class="max-w-[200px] rounded-lg border border-white/10 mb-2">`).join('');
      const html = `
        <div class="msg-group max-w-3xl mx-auto flex gap-4 md:gap-6 mb-8 msg-anim">
          <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg flex-shrink-0 overflow-hidden ${isNas ? 'shadow-lg shadow-blue-900/20' : ''}">
            ${isNas ? `<img src="${LOGO_URL}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-zinc-800 flex items-center justify-center text-[10px] text-zinc-400 font-bold">YOU</div>`}
          </div>
          <div class="flex-1 min-w-0 pt-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xs font-bold text-zinc-300">${isNas ? 'Nasoro' : 'You'}</span>
              ${isNas ? `<span class="text-[9px] px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-500 border border-white/5 uppercase tracking-wide">${currentModel.replace('nasoro-', '')}</span>` : ''}
            </div>
            ${imgHtml}
            <div class="${isNas ? 'prose prose-invert text-zinc-300' : 'user-txt text-white'} text-[15px] leading-relaxed">
              ${isNas ? parseMarkdown(content) : content.replace(/\n/g, '<br>')}
            </div>
          </div>
        </div>`;
      chatContainer.insertAdjacentHTML('beforeend', html);
      if(isNas) { document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el)); addCopyListeners(); }
      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      saveContext();
    }

    function parseMarkdown(text) { return marked.parse(text); }

    function addCopyListeners() {
      document.querySelectorAll('pre').forEach(pre => {
        if(!pre.querySelector('.copy-btn')) {
          const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.innerHTML = '<i class="fa-regular fa-copy"></i> Copy';
          btn.onclick = () => { const code = pre.querySelector('code').innerText; navigator.clipboard.writeText(code); btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied'; setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Copy', 2000); };
          pre.appendChild(btn);
        }
      });
    }

    async function handleSend() {
      const msg = chatField.value.trim();
      if(!msg && selectedImages.length === 0) return;

      sendAction.disabled = true;
      chatField.style.height = 'auto'; 
      
      postMessage(msg || '[Image Uploaded]', 'user', selectedImages);
      chatField.value = '';
      
      const payloadImages = [...selectedImages]; 
      selectedImages = [];
      renderImages();
      
      const tid = 'loading-'+Date.now();
      const loadingHtml = `
        <div id="${tid}" class="msg-group max-w-3xl mx-auto flex gap-4 md:gap-6 mb-8 msg-anim opacity-50">
          <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg overflow-hidden"><img src="${LOGO_URL}" class="w-full h-full object-cover"></div>
          <div class="flex gap-1 items-center h-8"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
        </div>`;
      chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      // GET PERSONA
      const persona = customPersonaInput.value;

      try {
        const res = await fetch(API_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          // INCLUDE CUSTOM PERSONA
          body: JSON.stringify({ message: msg, images: payloadImages, model: currentModel, customPersona: persona }) 
        });
        
        const data = await res.json();
        document.getElementById(tid).remove();
        
        if (res.status === 429) {
          showToast("⚠️ Rate limit reached. Slow down...");
          postMessage("I'm receiving too many requests. Please wait a moment...", 'nasoro');
          if("Notification" in window && Notification.permission === "granted") {
             new Notification("Rate Limit Hit", { body: "Take a breather, Nasoro needs a coffee break." });
          }
        } else if (res.ok) {
          postMessage(data.reply || "Thinking...", 'nasoro');
        } else {
          postMessage("System error. Please try again later...", 'nasoro');
        }

      } catch (err) { 
        console.error(err);
        document.getElementById(tid).remove(); 
        postMessage("Error: Could not connect to Nasoro Backend.", 'nasoro'); 
        showToast("❌ Connection Failed");
      } finally {
        sendAction.disabled = false;
        chatField.focus();
      }
    }

    function showToast(txt) {
      const el = document.getElementById('rate-limit-badge');
      el.innerText = txt;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    sendAction.addEventListener('click', handleSend);
    chatField.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
    
    renderArchive();
    setModel('nasoro-2-fast'); 
  </script>
</body>
</html>
